---
title: "Homework 6 Answer Key"
author: "Melinda K. Higgins, PhD."
date: "December 1, 2018"
output: html_document
---

```{r setup, include=FALSE}
# set up knitr options
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(message = FALSE)
knitr::opts_chunk$set(warning = FALSE)

# load packages needed
library(tidyverse)
library(haven)

# load dataset
helpdat <- haven::read_spss("helpmkh.sav")

# load knitr, printr, and kableExtra to get
# nicer formatted tables for the outputs
library(knitr)
library(printr)
library(kableExtra)
```

## Homework 06 - Logistic Regression - due 12/05/2018

### HELP Dataset

For Homework 06, you will be using the HELP dataset, learn more at:

* [https://melindahiggins2000.github.io/N736Fall2017_HELPdataset/](https://melindahiggins2000.github.io/N736Fall2017_HELPdataset/) &
* [https://github.com/melindahiggins2000/N736Fall2017_HELPdataset](https://github.com/melindahiggins2000/N736Fall2017_HELPdataset)

### Previous Exercises to Refer to

Refer to the logistic regression analysis example and codes we ran during lesson 18 and 19 - see [https://github.com/melindahiggins2000/N736Fall2017_lesson1819](https://github.com/melindahiggins2000/N736Fall2017_lesson1819)

### Variables to Consider in HELP Dataset

For the HELP dataset:

* OUTCOME VARIABLE: 
    - consider the variable `e2b` "Number of times in past 6 months entered a detox program - Baseline" 
    - recode this into a new variable `nodetox` for those who did NOT say they had entered a detox program 6mo prior to baseline and those who did 1 or more times (i.e. code the `e2b` missing as 1 and non-missing as 0 - see codes below to help you get started)
* PREDICTOR VARIABLE: consider these variables as potential predictors for `nodetox`:
    - `age`, `female`, `pss_fr`, `pcs`, `mcs`, and `cesd`
    
### Variables in HELP dataset to be used for Homework 06:

```{r, echo=FALSE, message=FALSE, warning=FALSE}
helpdata <- readRDS("helpmkh.rds")
library(tidyverse)
sub1 <- helpdata %>%
  select(e2b, age, female, pss_fr,
         pcs, mcs, cesd)

# create a function to get the label
# label output from the attributes() function
getlabel <- function(x) attributes(x)$label
# getlabel(sub1$age)

library(purrr)
ldf <- purrr::map_df(sub1, getlabel) # this is a 1x15 tibble data.frame
# t(ldf) # transpose for easier reading to a 15x1 single column list

# using knitr to get a table of these
# variable names for Rmarkdown
library(knitr)
knitr::kable(t(ldf),
             col.names = c("Variable Label"),
             caption="Use these variables from HELP dataset for Homework 06")

```
    

### Code to help you get started

* SPSS Code [https://github.com/melindahiggins2000/N736/raw/master/homework6_SPSSSyntax1.sps](https://github.com/melindahiggins2000/N736/raw/master/homework6_SPSSSyntax1.sps)
* SAS Code [https://github.com/melindahiggins2000/N736/raw/master/homework6_SAScode.sas](https://github.com/melindahiggins2000/N736/raw/master/homework6_SAScode.sas)
* R Code [https://github.com/melindahiggins2000/N736/raw/master/homework06_Rcode.R](https://github.com/melindahiggins2000/N736/raw/master/homework06_Rcode.R)

```{r}
helpdat <- haven::read_spss("helpmkh.sav")

# ============================================
# For this homework we'll use the helpmkh dataset
#
# You will be working with the e2b variable
# Number of times in past 6 months entered a 
# detox program (collected at Baseline)
#
# For this logistic regression homework 6,
# I've provided the code below to capture the
# individuals who did NOT say they had entered a detox
# program in the 6 months preceeding baseline
# ============================================

helpdat$nodetox <- is.na(helpdat$e2b)

# check results - there are 239 NA's or missing values
# for e2b - these should now be 0's for nodetox
summary(helpdat$e2b)
summary(helpdat$nodetox)

# another way to check using table
# to get a 2-way table
# and include NA's in output
# check that the NA's for e2b are TRUE's for nodetox
table(helpdat$e2b, helpdat$nodetox, useNA = "ifany")

# For this logistic regression homework, you will
# use nodetox as your main outcome variable
# which is a logic variables coded FALSE and TRUE. 
# R interprets FALSE as 0 and TRUE as 1. A
# logic class type variable works fine 
# as an outcome in logistic regression.

# We'll use logistic regression to predict
# whether someone in a detox program or not (nodetox)
# prior to baseline using these variables
# age, female, pss_fr, pcs, mcs, and cesd.
# ============================================

h1 <- helpdat %>%
  select(nodetox, age, female, pss_fr,
         pcs, mcs, cesd)
```

### Assignment - problem 1

Complete the following:

1. Consider the continuous variable `mcs` as a predictor for `nodetox`
    a. run a logistic regression of the probability of not being in a detox program prior to baseline (`nodetox`) given their mental health scores (`mcs`)
    b. make a plot of the the predicted probability of no detox (`nodetox`) by the mental health scores (`mcs`)
    c. what value of the `mcs` leads to a probability of not being in a detox program => 0.5? _(hint: use the plot you just made)_
    
#### Answer Key - problem 1

The logistic regression model is shown below.

```{r}
m1 <- glm(nodetox ~ mcs, data = h1, family=binomial)
m1
summary(m1)

# get odds ratios and 95% confidence intervals of odds ratios
exp(coef(m1))
exp(confint(m1))
```

Logistic Regression Model Output - better formatting using `knitr::kable()`.

```{r}
df1 <- data.frame(summary(m1)[["coefficients"]],
                  exp(coef(m1)),
                  exp(confint(m1)))
names(df1) <- c("B","SEb","Z","p-value","Odds Ratio (OR)",
                "OR 95% CI LB","OR 95% CI UB")
knitr::kable(df1)
```

Plot of predicted probabilities of `nodetox` given `mcs` scores. Horizontal and vertical lines drawn to estimate the value of `mcs` at which the probability switches at 0.5. This cutoff appears to be around 28-28.5 for `mcs`.

```{r}
m1.predict <- predict(m1, newdata=h1,
                      type="response")
plot(h1$mcs, m1.predict,
     xlab = "MCS - Mental Component Score SF36",
     ylab = "Model Predicted Probability of Not Being in Detox",
     main = "Probability of Not Being in Detox - Predicted by MCS scores")
abline(h=0.5, col="red")
abline(v=28, col="red")
```

For completeness, here is the confusion matrix for this model with 1 predictor given a cutoff of 0.5.

```{r}
#confusion matrix
table(h1$nodetox, m1.predict > 0.5,
      dnn = c("No Detox","Model Prediction"))

# UPDATE - look at %'s of total, set
# prop.r and prop.c to FALSE

library(gmodels)
CrossTable(h1$nodetox, m1.predict > 0.5,
           prop.r = FALSE,
           prop.c = FALSE,
           prop.t = TRUE,
           dnn = c("No Detox","Model Prediction"))
```

### Assignment - problem 2
    
2. Run a logistic regression model for the probability of not being in a detox program 6mo prior to baseline considering all of these possible predictor variables: `age`, `female`, `pss_fr`, `pcs`, `mcs`, and `cesd`:
    a. present the final model results (B, SE(of B), p-values, Odds Ratios, and 95% confidence intervals for the Odds Ratios)
    b. write a few sentences describing your results including:
        i. model fit _(report the Area Under the Curve (AUC) and include a ROC plot)_ - discuss if you think this is a good model or not for predicting not being in a detox program 6mo prior to baseline
        ii. model classification table results - remember to report the threshold used for the classification table - you can change it from 0.5 if you think a different threshold might work better
        iii. odds ratios for each significant predictor in the model _("...for every 1 unit change in the predictor the odds of not being in a detox program prior to baseline was x.xxx times higher/lower...")_

#### Answer Key - problem 2

```{r}
m2 <- glm(nodetox ~ age + female + pss_fr + pcs + mcs +
            cesd, data=h1, family=binomial)
summary(m2)
exp(coef(m2))
exp(confint(m2))
```

Logistic Regression Model Output - better formatting using `knitr::kable()`.

```{r}
df2 <- data.frame(summary(m2)[["coefficients"]],
                  exp(coef(m2)),
                  exp(confint(m2)))
names(df2) <- c("B","SEb","Z","p-value","Odds Ratio (OR)",
                "OR 95% CI LB","OR 95% CI UB")
knitr::kable(df2)
```

Classification table

```{r}
m2.predict <- predict(m2, newdata=h1,
                      type="response")

gmodels::CrossTable(h1$nodetox, m2.predict > 0.5,
                    prop.r = FALSE,
                    prop.c = FALSE,
                    prop.t = TRUE,
                    dnn = c("No Detox","Model Prediction"))

```

Make the ROC curve plot and get the AUC.

```{r}
# see https://www.r-bloggers.com/how-to-perform-a-logistic-regression-in-r/

# make an ROC curve for model m2
library(ROCR)
p <- predict(m2, newdata=h1, 
             type="response")
pr <- prediction(p, as.numeric(h1$nodetox))
prf <- performance(pr, measure = "tpr", 
                   x.measure = "fpr")
#plot(prf)
#abline(0, 1, col="red")

auc <- performance(pr, measure = "auc")
auc <- auc@y.values[[1]]
#auc

# UPDATE - add title to plot with AUC in title
plot(prf,
     main = paste("ROC Curve, AUC = ", round(auc, 3)))
abline(0, 1, col="red")
```

The area under the curve (AUC) is not great, AUC = `r auc` which is < 0.7, but it is > 0.5. The overall classification rate = 0.289 + 0.331 = `r .289 + .331`, which could also be better. The baseline rate = `r 239/453`, 52.8%, so the model with these 6 predictors is better than the NULL model but not by much.

In the final fitted model, only gender, physical and mental health scores were significant. For females, their odds of not being in detox was 1.94 times higher than the males. For every one point higher somone scored on their physical health scores, their odds of not being in detox was 1.026 times higher. And for every one point higher someone scored on their mental health, their odds of not being in detox was 1.032 times higher.

